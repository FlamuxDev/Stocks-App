@model Stocks_App.Models.StockTrade

@{
    ViewData["Title"] = "Trade";
}

<div class="trade-container">
    <div class="stock-header">
        <h1>@Model.StockName</h1>
        <h2>@Model.StockSymbol</h2>
    </div>
    
    <div class="stock-price-container">
        <div class="price-label">Price</div>
        <div class="price-value" id="stockPrice">$@Model.Price.ToString("F2")</div>
    </div>
    
    <div class="trade-form">
        <form id="buyForm" method="post" action="@Url.Action("BuyOrder", "Trade")" style="display: none;">
            @Html.AntiForgeryToken()
            <input type="hidden" name="StockSymbol" id="buyStockSymbol" />
            <input type="hidden" name="StockName" id="buyStockName" />
            <input type="hidden" name="Quantity" id="buyQuantity" />
            <input type="hidden" name="Price" id="buyPrice" />
        </form>
        
        <form id="sellForm" method="post" action="@Url.Action("SellOrder", "Trade")" style="display: none;">
            @Html.AntiForgeryToken()
            <input type="hidden" name="StockSymbol" id="sellStockSymbol" />
            <input type="hidden" name="StockName" id="sellStockName" />
            <input type="hidden" name="Quantity" id="sellQuantity" />
            <input type="hidden" name="Price" id="sellPrice" />
        </form>
        
        <div>
            <input type="hidden" id="stockSymbol" value="@Model.StockSymbol" />
            <input type="hidden" id="stockName" value="@Model.StockName" />
            
            <div class="form-group">
                <label for="quantity">Quantity:</label>
                <input type="number" id="quantity" name="quantity" min="1" value="@Model.Quantity" class="form-control" />
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-buy" id="buyButton">Buy</button>
                <button type="button" class="btn btn-sell" id="sellButton">Sell</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function() {
            const stockSymbol = document.getElementById('stockSymbol').value;
            const priceElement = document.getElementById('stockPrice');
            let ws = null;
            
            // Get token from server - we'll need to pass it from the controller
            const token = '@ViewData["FinnhubToken"]' || 'cc676uaad3i9rj8tb1s0';
            
            function connectWebSocket() {
                const wsUrl = `wss://ws.finnhub.io?token=${token}`;
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                    // Subscribe to the stock symbol
                    ws.send(JSON.stringify({'type':'subscribe', 'symbol': stockSymbol}));
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'trade' && data.data && data.data.length > 0) {
                            // Get the latest price (highest price from the data array)
                            const prices = data.data.map(trade => trade.p);
                            const latestPrice = Math.max(...prices);
                            
                            // Update the price display
                            priceElement.textContent = '$' + latestPrice.toFixed(2);
                            
                            // Add animation effect
                            priceElement.classList.add('price-updated');
                            setTimeout(() => {
                                priceElement.classList.remove('price-updated');
                            }, 500);
                        }
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
                
                ws.onclose = function() {
                    console.log('WebSocket closed');
                    // Attempt to reconnect after 3 seconds
                    setTimeout(connectWebSocket, 3000);
                };
            }
            
            // Connect when page loads
            connectWebSocket();
            
            // Buy button click handler
            document.getElementById('buyButton').addEventListener('click', function() {
                const quantity = parseInt(document.getElementById('quantity').value) || 0;
                const price = parseFloat(priceElement.textContent.replace('$', '')) || 0;
                const symbol = document.getElementById('stockSymbol').value;
                const name = document.getElementById('stockName').value;
                
                if (quantity > 0 && price > 0) {
                    document.getElementById('buyStockSymbol').value = symbol;
                    document.getElementById('buyStockName').value = name;
                    document.getElementById('buyQuantity').value = quantity;
                    document.getElementById('buyPrice').value = price;
                    document.getElementById('buyForm').submit();
                } else {
                    alert('Please enter a valid quantity and ensure price is available.');
                }
            });
            
            // Sell button click handler
            document.getElementById('sellButton').addEventListener('click', function() {
                const quantity = parseInt(document.getElementById('quantity').value) || 0;
                const price = parseFloat(priceElement.textContent.replace('$', '')) || 0;
                const symbol = document.getElementById('stockSymbol').value;
                const name = document.getElementById('stockName').value;
                
                if (quantity > 0 && price > 0) {
                    document.getElementById('sellStockSymbol').value = symbol;
                    document.getElementById('sellStockName').value = name;
                    document.getElementById('sellQuantity').value = quantity;
                    document.getElementById('sellPrice').value = price;
                    document.getElementById('sellForm').submit();
                } else {
                    alert('Please enter a valid quantity and ensure price is available.');
                }
            });
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', function() {
                if (ws) {
                    // Unsubscribe before closing
                    ws.send(JSON.stringify({'type':'unsubscribe', 'symbol': stockSymbol}));
                    ws.close();
                }
            });
        })();
    </script>
}

